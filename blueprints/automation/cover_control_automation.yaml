cover_tilt_wait_mode:
  name: "ðŸ”„ Tilt Wait Mode"
  description: >-
    **Fixed Delay**: Use configured tilt delay (default, works for most devices)
    
    **Wait Until Idle**: Wait for cover to reach idle state before tilting 
    (recommended for Z-Wave devices like Shelly Qubino that block tilt during movement)
  default: "fixed_delay"
  selector:
    select:
      options:
        - label: "â±ï¸ Fixed Delay (Standard)"
          value: "fixed_delay"
        - label: "â¸ï¸ Wait Until Idle (Z-Wave devices)"
          value: "wait_idle"
      mode: dropdown

tilt_wait_timeout:
  name: "ðŸ”„ Tilt Wait Timeout"
  description: >-
    Maximum time to wait for cover to become idle before sending tilt command.
    Only used when 'Wait Until Idle' mode is selected.
  default: 30
  selector:
    number:
      min: 5
      max: 60
      unit_of_measurement: seconds
      step: 1
      mode: slider

tilt_wait_safety_delay:
  name: "ðŸ”„ Safety Delay After Idle"
  description: >-
    Additional short delay after cover becomes idle and before sending tilt command.
    Gives device firmware time to be fully ready.
  default: 1
  selector:
    number:
      min: 0
      max: 5
      unit_of_measurement: seconds
      step: 0.5
      mode: slider



# Tilt wait mode configuration
tilt_wait_mode: !input cover_tilt_wait_mode
tilt_wait_timeout: !input tilt_wait_timeout
tilt_wait_safety_delay: !input tilt_wait_safety_delay
is_tilt_wait_idle_mode: "{{ tilt_wait_mode == 'wait_idle' }}"




tilt_move_action: &tilt_move_action
  sequence:
    - if:
        - "{{ not prevent_flags.default_cover_actions }}"
        - "{{ is_cover_tilt_enabled_and_possible }}"
        - "{{ expand(blind_entities) | selectattr('attributes.current_tilt_position', 'defined') | list | count > 0 }}"
      then:
        - repeat:
            for_each: "{{ blind_entities | list }}"
            sequence:
              # Optional: Reset tilt first (if reposition enabled)
              - if:
                  - "{{ tilt_first | default(false) }}"
                then:
                  - alias: "Reset Tilt"
                    service: cover.set_cover_tilt_position
                    data:
                      tilt_position: 0
                    target:
                      entity_id: "{{ repeat.item if repeat is defined else '' }}"
                  - delay:
                      seconds: !input tilt_delay
              
              # Wait strategy based on mode
              - choose:
                  # Mode: Wait until idle
                  - conditions:
                      - "{{ is_tilt_wait_idle_mode }}"
                    sequence:
                      - alias: "Wait for cover to become idle"
                        wait_template: >-
                          {% set cover_state = states(repeat.item) %}
                          {{ cover_state in ['open', 'closed'] }}
                        timeout: "{{ '%0.2d:%0.2d:%0.2d' | format(0, 0, tilt_wait_timeout | int) }}"
                        continue_on_timeout: true
                      
                      - if:
                          - "{{ wait.completed }}"
                        then:
                          - alias: "Cover reached idle state - apply safety delay"
                            delay:
                              seconds: "{{ tilt_wait_safety_delay }}"
                        else:
                          - alias: "Timeout reached - log warning and continue"
                            service: system_log.write
                            data:
                              level: warning
                              message: >-
                                CCA: Cover {{ repeat.item }} did not reach idle state within 
                                {{ tilt_wait_timeout }}s. Sending tilt command anyway.
                              logger: "blueprints.hvorragend.cca"
                
                # Mode: Fixed delay (default/backward compatible)
                default:
                  - alias: "Standard tilt delay"
                    delay:
                      seconds: !input tilt_delay
              
              # Send tilt command
              - alias: "Set tilt position"
                service: cover.set_cover_tilt_position
                data:
                  tilt_position: "{{ target_tilt_position | default(101) }}"
                target:
                  entity_id: "{{ repeat.item if repeat is defined else '' }}"
              
              - delay:
                  seconds: "{{ (range(1, 3) | random | int) }}"


cover_tilt_wait_mode:
  description: >-
    Choose how CCA waits before sending tilt commands:
    
    **Fixed Delay (Standard)**: Uses the configured tilt delay value. 
    Works well for most devices.
    
    **Wait Until Idle (Z-Wave)**: Waits until cover reports 'open' or 'closed' 
    state before sending tilt. Prevents tilt commands from being ignored on 
    devices that block tilt during motor movement (e.g., Shelly Qubino Wave Shutter).
    
    If your tilt positions are unreliable, try switching to 'Wait Until Idle' mode.
